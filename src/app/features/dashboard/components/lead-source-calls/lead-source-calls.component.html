<!-- src/app/features/dashboard/components/lead-source-calls/lead-source-calls.component.html -->
<div>
  <div *ngIf="filteredCalls.length === 0" class="text-center py-12 text-gray-500">
    <div class="flex flex-col items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
      <div *ngIf="leadSource === 'sumup'; else noCallsGeneric">
        <h3 class="text-sm font-medium text-gray-900 mb-1">No SumUp payment leads found</h3>
        <p class="text-xs text-gray-500">SumUp leads will appear here when they are scheduled for follow-up calls.</p>
      </div>
      <ng-template #noCallsGeneric>
        <h3 class="text-sm font-medium text-gray-900 mb-1">No calls found for this lead source</h3>
        <p class="text-xs text-gray-500">Calls from this lead source will appear here when scheduled.</p>
      </ng-template>
    </div>
  </div>

  <div *ngIf="filteredCalls.length > 0" class="space-y-4">
    <div *ngFor="let call of filteredCalls" class="flex flex-col pb-4 border-b border-gray-100 last:border-b-0"
         (click)="onViewCallDetails(call.id, $event)">
      <div class="flex items-start">
        <div class="mr-4 text-center min-w-[80px]">
          <div class="text-sm font-medium text-blue-900 bg-blue-50 px-2 py-1 rounded-lg">{{ formatTime(call.scheduled_at) }}</div>
          <div class="text-xs text-gray-500 mt-2" *ngIf="call.lead_source">
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 group relative"
                  [title]="'Lead source: ' + getLeadSourceFullName(call.lead_source)">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              {{ getLeadSourceFullName(call.lead_source) }}
              <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-1 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10">
                Source where this lead was generated
              </div>
            </span>
          </div>
        </div>

        <div class="flex-1 min-w-0">
          <!-- Contact Name with Company -->
          <div class="flex items-center">
            <div class="font-medium text-gray-900 text-sm">
              {{ call.contact?.first_name }} {{ call.contact?.last_name }}
              <span *ngIf="call.contact?.company?.name" class="font-normal text-gray-600">
                [{{ call.contact?.company?.name }}]
              </span>
            </div>
          </div>

          <!-- Call Reason -->
          <div class="text-xs text-gray-600 mt-1">{{ call.reason }}</div>

          <!-- Indicators -->
          <div class="mt-2 flex items-center space-x-2">
            <div *ngIf="call.importance && call.importance > 3" class="text-xs text-gray-500">High priority</div>
            <div *ngIf="call.is_first_call" class="text-xs text-gray-500">First call</div>
          </div>

          <!-- Notes (if any) -->
          <div *ngIf="call.notes && call.notes.trim().length > 0 && activeNotesCallId !== call.id" class="mt-2 text-xs text-gray-600 bg-gray-50 p-2 border-l border-gray-200">
            <div class="font-medium text-xs text-gray-500 mb-1">Notes:</div>
            {{ call.notes }}
          </div>
        </div>

        <div class="flex flex-col space-y-1">
          <!-- Call Button -->
          <button (click)="onInitiateCall(call, $event)" class="btn-success">
            Call
          </button>

          <!-- Complete Button -->
          <button (click)="onCompleteCall(call.id, $event)" class="btn-secondary text-xs">
            Complete
          </button>

          <!-- Reschedule Button -->
          <button (click)="onRescheduleCall(call, $event)" class="btn-secondary text-xs">
            Reschedule
          </button>

          <!-- Add/Edit Notes Button -->
          <button (click)="toggleNotesEditor(call.id, $event)" class="btn-secondary text-xs">
            {{ call.notes ? 'Edit Notes' : 'Add Notes' }}
          </button>
        </div>
      </div>

      <!-- Notes Editor (when active) -->
      <div *ngIf="activeNotesCallId === call.id" class="mt-3 p-3 bg-gray-50 border border-gray-200" (click)="$event.stopPropagation()">
        <textarea
          [(ngModel)]="noteText"
          class="w-full p-2 border border-gray-300 text-sm"
          rows="3"
          placeholder="Enter notes..."></textarea>
        <div class="flex justify-end mt-2 space-x-2">
          <button
            (click)="toggleNotesEditor(call.id, $event)"
            class="btn-secondary text-xs">
            Cancel
          </button>
          <button
            (click)="saveNotes(call.id, $event)"
            class="btn-primary text-xs">
            Save Notes
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
